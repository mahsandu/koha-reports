SELECT
    cardnumber,
    barcode,
    itemnumber,
    DueDate,
    ReturnDate,
    DueDays,
    1 AS TodayInCalc,
    7 AS GracePeriod,
    Holidays,
    (DueDays - (Holidays + 8)) AS FineDays,
    ((DueDays - (Holidays + 8)) * 2) AS TotalFine,
    CAST(Amount AS SIGNED) AS Amount,
    status,
    timestamp,
    credit_type_code
FROM (
    SELECT
        b.cardnumber AS cardnumber,
        i.barcode AS barcode,
        a.itemnumber AS itemnumber,
        DATE_FORMAT(o.date_due, '%d-%m-%Y') AS DueDate,
        DATE_FORMAT(o.returndate, '%d-%m-%Y') AS ReturnDate,
        CAST(DATEDIFF(o.returndate, o.date_due) AS SIGNED) AS DueDays,
        CAST(SUM(DATEDIFF(o.returndate, o.date_due) /7) AS SIGNED) AS HoliDays,
        CAST(a.amountoutstanding AS SIGNED) AS AmountOutStanding,
        CAST(a.amount AS SIGNED) AS Amount,
        a.status AS status,
        a.timestamp AS timestamp,
        a.credit_type_code AS credit_type_code
    FROM
        (
            (
                accountlines a
                LEFT JOIN old_issues o ON o.itemnumber = a.itemnumber
            )
            LEFT JOIN items i ON i.itemnumber = a.itemnumber
        )
        LEFT JOIN borrowers b ON b.borrowernumber = a.borrowernumber
    WHERE
        a.amountoutstanding > 0
        AND STATUS ='RETURNED'
        AND a.itemnumber = '12780' -- Replace with the itemnumber you want to filter by
    GROUP BY
        a.borrowernumber
) AS DerivedTable;
