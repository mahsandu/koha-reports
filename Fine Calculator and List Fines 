SELECT
    cardnumber,
    barcode,
    itemnumber,
    DueDate,
    TotalDays,
    CAST(AmountOutStanding AS SIGNED) AS AmountOutStanding,
    CAST(Amount AS SIGNED) AS Amount,
    (TotalDays * 2) AS TotalFine,
    status,
    timestamp,
    credit_type_code
    
FROM (
    SELECT
        b.cardnumber AS cardnumber,
        i.barcode AS barcode,
        a.itemnumber AS itemnumber,
        DATE_FORMAT(o.date_due, '%d-%m-%Y') AS DueDate,
        DATEDIFF(CURDATE(), o.date_due) - 6 - (
            SELECT COUNT(*)
            FROM issues
            WHERE date_due >= o.date_due
            AND DATE_FORMAT(date_due, '%W') = 'Friday'
        ) AS TotalDays,
        CAST(a.amountoutstanding AS SIGNED) AS AmountOutStanding,
        CAST(a.amount AS SIGNED) AS Amount,
        a.status AS status,
        a.timestamp AS timestamp,
        a.credit_type_code AS credit_type_code
    FROM
        (
            (
                accountlines a
                LEFT JOIN issues o ON o.itemnumber = a.itemnumber
            )
            LEFT JOIN items i ON i.itemnumber = a.itemnumber
        )
        LEFT JOIN borrowers b ON b.borrowernumber = a.borrowernumber
    WHERE
        a.amountoutstanding > 0
        AND a.status LIKE 'UNRETURNED'
    GROUP BY
        a.borrowernumber
) AS DerivedTable;
